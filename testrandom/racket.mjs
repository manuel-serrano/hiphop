/*=====================================================================*/
/*    serrano/prgm/project/hiphop/hiphop/testrandom/racket.mjs         */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Fri Oct 24 16:29:15 2025                          */
/*    Last change :  Tue Oct 28 09:34:47 2025 (serrano)                */
/*    Copyright   :  2025 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Testing some programs with racket/esterel                        */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    The module                                                       */
/*---------------------------------------------------------------------*/
export { ReactiveMachine };
import { writeFileSync } from "node:fs";
import { spawnSync } from "child_process";

/*---------------------------------------------------------------------*/
/*    json2racket ...                                                  */
/*---------------------------------------------------------------------*/
function json2racket(o) {

   function expr2racket(expr) {
      if (expr === "false") {
	 return { racket: "#f", expr: expr };
      } else if (expr === "true") {
	 return { racket: "#t", expr: expr };
      } else {
	 let m = expr.match(/![(](.*)[)]/);

	 if (m) {
	    return { racket: `(not ${expr2racket(m[1]).racket})`, expr: expr };
	 }

	 if (m = expr.match(/this[.]([a-zA-Z0-9_]*)[.]now/)) {
	    return { racket: `(present? ${m[1]})`, expr: expr };
	 }

	 if (m = expr.match(/this[.]([a-zA-Z0-9_]*)[.]pre/)) {
	    return { racket: `(present? ${m[1]} #:pre 1)`, expr: expr };
	 }

	 if (expr[0] === "(") {
	    const { racket: lhs, expr: subexpr } = expr2racket(expr.substr(1));
	    const nexpr = expr.substr(1 + subexpr.length);

	    if (nexpr.match(/[ ]*&&[ ]*(.*)[)]/)) {
	       const { racket: rhs, expr } = expr2racket(m[1]);
	       return { racket: `(and ${lhs} ${rhs}`, expr: expr};
	    }
	    
	    if (nexpr.match(/[ ]*||[ ]*(.*)[)]/)) {
	       const { racket: rhs, expr } = expr2racket(m[1]);
	       return { racket: `(or ${lhs} ${rhs}`, expr: expr};
	    }
	 }

	 return { racket: `"Unsupported expression ${expr}"`, expr: expr };
      }
   }
   
   function childrenOf(o) {
      if (o.children.length === 1) {
	 return json2racket(o.children[0]);
      } else {
	 return `(begin ${o.children.map(json2racket).join("\n")})`;
      }
   }

   function if2racket({func, children}) {
      return `(if (begin "func" ${expr2racket(func).racket}) ${json2racket(children[0])} ${json2racket(children[1])})`
   }
   
   switch (o.node) {
      case "module":
	 return `(esterel ${childrenOf(o)})`;
      case "loop":
	 return `(loop ${childrenOf(o)})`;
      case "if":
	 return if2racket(o);
      case "local":
	 return `(with-signal (${o.signals.join(" ")}) ${childrenOf(o)})`;
      case "nothing":
	 return "(void)";
      case "pause":
	 return "(pause)";
      case "seq":
	 return childrenOf(o);
      case "trap":
	 return `(with-trap ${o.trapName} ${childrenOf(o)})`;
      case "exit":
	 return `(exit-trap ${o.trapName})`;
      case "par":
	 return `(par ${childrenOf(o)})`;
      case "atom":
	 return `(begin "${o.func}" ${expr2racket(o.func).racket})`;
      case "emit":
	 return `(emit ${o.signame})`;
      default:
	 return `"Unsupported node ${o.node}"`;
   }
}

/*---------------------------------------------------------------------*/
/*    runRacket ...                                                    */
/*---------------------------------------------------------------------*/
function runRacket(file) {

   const child = spawnSync("racket", [file]);
   const out = child.stdout.toString();
   return JSON.parse(out);
}

/*---------------------------------------------------------------------*/
/*    ReactiveMachine ...                                              */
/*---------------------------------------------------------------------*/
function ReactiveMachine(prog, opts) {
   const rktfile = "/tmp/prog.hh.rkt";
   const eventsfile = "/tmp/prog.events.rkt";
   const events = [];
   const rktProg =
      ";; generated by testrandom\n"
      + "#lang racket\n"
      + ('(require esterel/full)\n')
      + ('\n')
      + ("(define (cons* a . x)\n")
      + ("   (define (consx x) (if (null? (cdr x)) (car x) (cons (car x) (consx (cdr x)))))\n")
      + ("   (if (null? x) a (cons a (consx x))))\n")
      + ('\n')
      + ('(define (hash-to-json hash)\n')
      + ('   (let ((keys (hash-keys hash)))\n')
      + ('      (if (null? keys)\n')
      + ("          '(\"{}\")\n")
      + ("          (append '(\"{\")\n")
      + ('             (let loop ((keys keys))\n')
      + ('                (cons* "\\\"" (signal-name (car keys)) "\\\": null"\n')
      + ('                   (if (pair? (cdr keys))\n')
      + ('                       (cons ", " (loop (cdr keys)))\n')
      + ("                       '())))\n")
      + ("             '(\"}\")))))\n")
      + ('\n')
      + (`(define (run-mach machine events)\n`)
      + (`   (cons "["\n`)
      + (`      (let loop ((events events))\n`)
      + (`         (cons* "{"\n`)
      + (`           "\\\"status\\\": \\\"success\\\", \\\"signals\\\":"\n`)
      + (`           (append (hash-to-json (react! machine))\n`)
      + (`              (cons "}"\n`)
      + (`                 (if (pair? (cdr events))\n`)
      + (`                     (cons* "," (loop (cdr events)))\n`)
      + (`                     '("]"))))))))\n`)
      + ('\n')
      + (`(define machine ${json2racket(prog.tojson())})\n`)
      + ('\n')
      + (`(let ((events (call-with-input-file "/tmp/prog.events.rkt" read)))\n`)
      + (`   (with-handlers ([exn:fail? (lambda (x) (display (exn-message x) (current-error-port)) (newline (current-error-port)) (display "[{\\\"status\\\": \\\"failure\\\", \\\"msg\\\": \\\"") (display (regexp-replace* #rx"\n" (exn-message x) " ")) (display "\\\", \\\"reason\\\": \\\"exception\\\"}]"))])\n`)
      + ('      (display (apply string-append (run-mach machine events)))))\n');
   

   writeFileSync(rktfile, rktProg);

   return { file: rktfile,
	    name() { return opts.name || "racket" },
	    react(e) { events.push("()") },
	    end() { writeFileSync(eventsfile, `(${events.join(" ")})`); return runRacket(rktfile) },
	    opts: {} };
}


